<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seguro Viagem Coris | Remessa Online</title>
    
    <!-- Ícone -->
    <link rel="icon" href="https://cms-cdn-sae1.remessaonline.com.br/Symbol_f6fc626f38.svg">

    <!-- Bibliotecas Essenciais -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://js.stripe.com/v3/" async></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/pt.js"></script>
    <script src="https://unpkg.com/imask"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary: #2244FF; --dark: #000733; }
        body { font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; scroll-behavior: smooth; }
        
        .btn-primary { background-color: var(--primary); color: white; border-radius: 99px; transition: all 0.3s; box-shadow: 0 4px 6px -1px rgba(34, 68, 255, 0.2); }
        .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(34, 68, 255, 0.3); }
        .btn-primary:disabled { opacity: 0.7; cursor: not-allowed; }
        
        .form-field { border: 1px solid #E5E7EB; background: #FFFFFF; border-radius: 12px; padding: 12px 16px; width: 100%; transition: all 0.2s; font-size: 14px; }
        .form-field:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(34, 68, 255, 0.1); }
        
        .hero-section { background: linear-gradient(135deg, #2244FF 0%, #00158A 100%); position: relative; overflow: hidden; }
        
        .plan-card { background: white; border: 1px solid #F3F4F6; border-radius: 20px; overflow: hidden; transition: all 0.3s; position: relative; display: flex; flex-direction: column; justify-content: space-between; }
        .plan-card:hover { border-color: var(--primary); transform: translateY(-4px); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
        
        .loader { width: 20px; height: 20px; border: 2px solid currentColor; border-bottom-color: transparent; border-radius: 50%; display: inline-block; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .fade-in-up { animation: fadeInUp 0.6s ease-out forwards; opacity: 0; transform: translateY(20px); }
        @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <header class="bg-white/95 backdrop-blur-sm sticky top-0 z-50 border-b border-gray-100 shadow-sm">
        <div class="container mx-auto px-6 h-20 flex items-center justify-between max-w-7xl">
            <div class="flex items-center gap-4 sm:gap-6">
                <a href="https://www.remessaonline.com.br/" target="_blank" class="hover:opacity-80 transition">
                    <img src="https://cms-cdn-sae1.remessaonline.com.br/Remessa_Online_Azul_Vertical_Principal_3ebe3d3a8d.svg" alt="Remessa Online" class="h-8 md:h-10 w-auto">
                </a>
                <div class="h-8 w-px bg-gray-200 hidden sm:block"></div>
                <div class="hidden sm:flex flex-col justify-center">
                    <span class="text-[9px] font-bold text-gray-400 uppercase tracking-widest leading-none mb-1">Parceria Oficial</span>
                    <img src="https://emissoes.coris.com.br/img/logo_emisoes_2024.jpg" alt="Coris" class="h-6 w-auto object-contain opacity-80 grayscale hover:grayscale-0 transition-all">
                </div>
            </div>
            <nav class="hidden md:flex items-center gap-8">
                <a href="#cotacao" class="text-sm font-medium text-gray-600 hover:text-[#2244FF]">Cotação</a>
                <a href="#faq" class="text-sm font-medium text-gray-600 hover:text-[#2244FF]">Dúvidas</a>
                <a href="https://www.remessaonline.com.br/entrar" target="_blank" class="border border-[#2244FF] text-[#2244FF] px-6 py-2 rounded-full text-sm font-semibold hover:bg-blue-50 transition-colors">Acessar Conta</a>
            </nav>
        </div>
    </header>

    <main>
        <section id="hero" class="hero-section py-20 lg:py-32 text-white">
            <div class="container mx-auto px-6 max-w-7xl relative z-10">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-16 items-center">
                    <div class="fade-in-up">
                        <div class="inline-flex items-center gap-2 bg-white/10 border border-white/20 backdrop-blur-sm px-4 py-2 rounded-full text-xs font-bold uppercase tracking-wider mb-8 shadow-lg">
                            <span class="w-2 h-2 rounded-full bg-green-400 animate-pulse"></span> Exclusivo Cliente Remessa
                        </div>
                        <h1 class="text-4xl lg:text-6xl font-extrabold leading-[1.1] mb-6 tracking-tight">Viaje protegido <br> pagando menos.</h1>
                        <p class="text-lg text-blue-100/90 font-light mb-10 max-w-lg leading-relaxed">Seguro Viagem Coris com <strong>15% OFF</strong> e <strong>2GB de internet grátis</strong>.</p>
                        <a href="#cotacao" class="bg-white text-[#2244FF] px-8 py-4 rounded-full font-bold text-lg hover:bg-blue-50 transition-all shadow-xl hover:-translate-y-1 text-center inline-flex items-center gap-2">
                            <span>Cotar com 15% OFF</span> <i data-lucide="arrow-right" class="w-5 h-5"></i>
                        </a>
                    </div>
                    <div class="hidden lg:flex justify-end relative fade-in-up" style="animation-delay: 0.2s;">
                        <div class="relative w-[500px] h-[500px]">
                            <div class="absolute inset-0 bg-white/5 rounded-full blur-3xl animate-pulse"></div>
                            <div class="absolute inset-0 flex items-center justify-center">
                                <div class="bg-white/10 backdrop-blur-md border border-white/20 p-8 rounded-3xl shadow-2xl transform rotate-3 hover:rotate-0 transition duration-500">
                                    <i data-lucide="shield-check" class="w-32 h-32 text-white opacity-90"></i>
                                    <div class="mt-4 text-center"><p class="text-white font-bold text-xl">100% Seguro</p><p class="text-white/70 text-sm">Cobertura Global</p></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="cotacao" class="relative z-20 -mt-16 px-4 pb-20">
            <div class="container mx-auto max-w-5xl">
                <div class="bg-white rounded-[32px] shadow-2xl border border-gray-100 p-8 md:p-12 fade-in-up" style="animation-delay: 0.3s;">
                    <div class="text-center mb-10">
                        <span class="bg-blue-50 text-blue-700 text-xs font-bold px-3 py-1 rounded-full uppercase tracking-wider">Simulador Oficial</span>
                        <h2 class="text-3xl font-bold text-gray-900 mt-4 mb-2">Para onde você vai?</h2>
                        <p class="text-gray-500">Preencha os dados abaixo para ver os planos disponíveis.</p>
                    </div>
                    <form id="quote-form" class="space-y-8">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">Destino</label>
                                <div class="relative"><select id="destination" class="form-field appearance-none cursor-pointer bg-white" required><option value="" disabled selected>Selecione a região...</option><option value="1">América Latina</option><option value="2">Brasil</option><option value="4">Mundo (Exceto EUA)</option><option value="5">Mundo (Incluindo EUA)</option></select><i data-lucide="map-pin" class="absolute right-4 top-3.5 w-4 h-4 text-gray-400 pointer-events-none"></i></div>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">Tipo de Viagem</label>
                                <div class="relative"><select id="trip-type" class="form-field appearance-none cursor-pointer bg-white" required><option value="1">Lazer / Negócios</option><option value="2">Intercâmbio</option><option value="3">Multiviagem (Anual)</option></select><i data-lucide="briefcase" class="absolute right-4 top-3.5 w-4 h-4 text-gray-400 pointer-events-none"></i></div>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="md:col-span-2 grid grid-cols-2 gap-4">
                                <div><label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">Ida</label><div class="relative"><input id="departure-date" class="form-field pl-10 cursor-pointer" placeholder="DD/MM/AAAA" readonly><i data-lucide="calendar" class="absolute left-3 top-3.5 w-4 h-4 text-gray-400"></i></div></div>
                                <div><label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">Volta</label><div class="relative"><input id="return-date" class="form-field pl-10 cursor-pointer" placeholder="DD/MM/AAAA" readonly><i data-lucide="calendar" class="absolute left-3 top-3.5 w-4 h-4 text-gray-400"></i></div></div>
                            </div>
                            <div class="flex flex-col justify-end"><div id="duration-display" class="hidden bg-blue-50 border border-blue-100 rounded-xl p-3 text-center h-[48px] flex items-center justify-center"><span class="text-blue-700 font-semibold text-sm">Duração: <strong id="days-count">0</strong> dias</span></div></div>
                        </div>
                        <div class="bg-gray-50 rounded-2xl p-6 border border-gray-100 transition-all hover:border-gray-200">
                            <div class="flex items-center justify-between mb-4">
                                <label class="text-sm font-bold text-gray-700 flex items-center gap-2"><i data-lucide="users" class="w-4 h-4 text-gray-400"></i> Passageiros</label>
                                <div class="flex items-center gap-3 bg-white border border-gray-200 rounded-lg p-1 shadow-sm">
                                    <button type="button" onclick="updatePax(-1)" class="w-8 h-8 flex items-center justify-center text-gray-500 hover:bg-gray-100 rounded transition font-bold text-lg">-</button>
                                    <span id="pax-count-display" class="font-bold text-gray-900 w-6 text-center select-none">1</span>
                                    <button type="button" onclick="updatePax(1)" class="w-8 h-8 flex items-center justify-center text-gray-500 hover:bg-gray-100 rounded transition font-bold text-lg">+</button>
                                </div>
                            </div>
                            <div id="ages-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-6 gap-3"><!-- JS --></div>
                        </div>
                        <div class="pt-4 text-center">
                            <button type="submit" id="btn-submit" class="btn-primary px-12 py-4 text-lg w-full md:w-auto shadow-xl hover:shadow-2xl relative overflow-hidden group">
                                <span class="relative z-10 flex items-center justify-center gap-2 font-bold">Ver Planos e Preços <i data-lucide="search" class="w-5 h-5 group-hover:scale-110 transition-transform"></i></span>
                            </button>
                            <div id="error-message" class="text-red-500 text-sm mt-4 hidden bg-red-50 p-3 rounded-lg border border-red-100"></div>
                        </div>
                    </form>
                </div>
            </div>
        </section>

        <section id="results" class="py-16 bg-white hidden min-h-[500px]">
            <div class="container mx-auto px-6 max-w-6xl">
                <div class="text-center mb-12 fade-in-up">
                    <h2 class="text-3xl font-bold text-gray-900">Planos Encontrados</h2>
                    <p class="text-gray-500 mt-2">Valores já com o desconto <span class="font-bold text-[#2244FF]">15% OFF</span> aplicado.</p>
                </div>
                <div id="plans-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>
            </div>
        </section>

        <section id="faq" class="py-20 bg-white border-t border-gray-100">
            <div class="container mx-auto px-6 max-w-4xl">
                <h2 class="text-2xl font-bold text-gray-900 mb-10 text-center">Dúvidas Frequentes</h2>
                <div class="space-y-4">
                    <div class="bg-gray-50 p-6 rounded-2xl border border-gray-100 shadow-sm">
                        <h3 class="font-bold text-gray-900 flex items-center gap-3"><i data-lucide="help-circle" class="w-5 h-5 text-gray-400"></i> O desconto é aplicado sobre qual valor?</h3>
                        <p class="text-sm text-gray-500 mt-2 ml-8">Sobre o valor total do prêmio. O preço exibido já é o final.</p>
                    </div>
                    <div class="bg-gray-50 p-6 rounded-2xl border border-gray-100 shadow-sm">
                        <h3 class="font-bold text-gray-900 flex items-center gap-3"><i data-lucide="wifi" class="w-5 h-5 text-gray-400"></i> Como recebo o chip grátis?</h3>
                        <p class="text-sm text-gray-500 mt-2 ml-8">Após a confirmação, você receberá um e-mail com o QR Code do eSIM.</p>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer class="bg-[#111] text-gray-400 py-12 text-xs border-t border-gray-800">
        <div class="container mx-auto px-6 max-w-7xl text-center">
            <p class="mb-4">A Remessa Online é uma plataforma digital da Bee Tech Serviços de Tecnologia Ltda. Seguro garantido pela Chubb Seguros Brasil S.A.</p>
            <p>© 2025 Remessa Online. Todos os direitos reservados.</p>
        </div>
    </footer>

    <!-- MODAL CHECKOUT -->
    <div id="checkout-modal" class="fixed inset-0 z-[100] hidden">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm opacity-0 transition-opacity" id="modal-backdrop"></div>
        <div class="absolute inset-0 flex items-center justify-center p-4">
            <div class="bg-white rounded-3xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col transform scale-95 opacity-0 transition-all duration-300" id="modal-panel">
                <div class="p-6 border-b border-gray-100 flex justify-between items-center">
                    <h3 class="text-xl font-bold text-gray-900">Finalizar Compra</h3>
                    <button onclick="closeModal()" class="text-gray-500 hover:text-red-500"><i data-lucide="x" class="w-6 h-6"></i></button>
                </div>
                <div class="p-6 overflow-y-auto flex-1 custom-scrollbar">
                    <form id="payment-form" class="space-y-6">
                        <div class="bg-blue-50 border border-blue-100 rounded-xl p-5">
                            <div class="flex justify-between font-bold text-blue-900 text-lg">
                                <span id="summary-plan">Plano</span> <span id="summary-price">R$ 0,00</span>
                            </div>
                            <div class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded inline-block mt-2">15% OFF Aplicado</div>
                        </div>
                        <div>
                            <h4 class="text-sm font-bold uppercase mb-4 text-gray-500">1. Titular</h4>
                            <div class="grid md:grid-cols-2 gap-4">
                                <input id="buyer-name" class="form-field" placeholder="Nome Completo" required>
                                <input id="buyer-email" class="form-field" placeholder="E-mail" type="email" required>
                                <input id="buyer-cpf" class="form-field" placeholder="CPF" required>
                                <input id="buyer-phone" class="form-field" placeholder="Celular" required>
                            </div>
                            <div class="grid grid-cols-4 gap-4 mt-4">
                                <input id="buyer-cep" class="form-field col-span-1" placeholder="CEP" required>
                                <input id="buyer-addr" class="form-field col-span-2 bg-gray-50" placeholder="Endereço" readonly>
                                <input id="buyer-num" class="form-field col-span-1" placeholder="Nº" required>
                            </div>
                        </div>
                        <div id="pax-forms-container"></div>
                        <div>
                            <h4 class="text-sm font-bold uppercase mb-4 text-gray-500">2. Pagamento</h4>
                            <div class="border border-gray-300 rounded-xl p-4 bg-white" id="card-container"><div id="card-element"></div></div>
                            <div id="card-errors" class="text-red-500 text-xs mt-2 hidden"></div>
                        </div>
                        <div class="flex items-start gap-2 text-xs text-gray-500"><input type="checkbox" required class="mt-1"> Li e concordo com as Condições Gerais.</div>
                        <button type="submit" id="btn-pay" class="btn-primary w-full py-4 text-lg shadow-xl font-bold flex justify-center items-center gap-2"><i data-lucide="lock" class="w-4 h-4"></i> Pagar e Emitir</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        const STATE = { paxCount: 1, searchData: {}, selectedPlan: null };
        let stripe, card;

        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            const config = { dateFormat: "d/m/Y", minDate: "today", locale: "pt", disableMobile: "true" };
            const fp1 = flatpickr("#departure-date", { ...config, onChange: (d) => { flatpickr("#return-date", config).set('minDate', d[0]); calcDuration(); }});
            flatpickr("#return-date", { ...config, onChange: calcDuration });
            updatePax(0);
            
            if(window.Stripe) {
                stripe = Stripe('pk_live_51S0mcpFWoZCz7UUNSC4AQ34VHLEqOAmy0j84mMhhDfn0uILIYabgbxkCWZiaE70OLLhrRYdAHcFbNIaJScjlpvZB006GCqwN3x');
                const elements = stripe.elements();
                card = elements.create('card', { hidePostalCode: true, style: { base: { fontSize: '16px', color: "#32325d", fontFamily: 'Inter, sans-serif' } } });
                card.mount('#card-element');
                card.on('change', ({error}) => { const err = document.getElementById('card-errors'); if(error) { err.textContent = error.message; err.classList.remove('hidden'); } else { err.classList.add('hidden'); } });
            }
            
            // Máscaras
            IMask(document.getElementById('buyer-cpf'), {mask: '000.000.000-00'});
            IMask(document.getElementById('buyer-phone'), {mask: '(00) 00000-0000'});
            const cepMask = IMask(document.getElementById('buyer-cep'), {mask: '00000-000'});
            document.getElementById('buyer-cep').addEventListener('input', async () => {
                if(cepMask.unmaskedValue.length === 8) {
                    try { const res = await fetch(`https://viacep.com.br/ws/${cepMask.unmaskedValue}/json/`); const data = await res.json(); if(!data.erro) { document.getElementById('buyer-addr').value = `${data.logradouro}, ${data.bairro} - ${data.localidade}/${data.uf}`; document.getElementById('buyer-num').focus(); } } catch(e){}
                }
            });
        });

        function calcDuration() {
            const d1 = document.getElementById('departure-date')._flatpickr.selectedDates[0];
            const d2 = document.getElementById('return-date')._flatpickr.selectedDates[0];
            if(d1 && d2) {
                const diff = Math.ceil((d2 - d1)/(1000*60*60*24)) + 1;
                if(diff > 0) { document.getElementById('days-count').innerText = diff; document.getElementById('duration-display').classList.remove('hidden'); }
            }
        }

        function updatePax(delta) {
            let n = STATE.paxCount + delta; if(n < 1) n = 1; if(n > 6) n = 6; STATE.paxCount = n;
            document.getElementById('pax-count-display').innerText = n;
            const container = document.getElementById('ages-grid'); container.innerHTML = '';
            for(let i=0; i<n; i++) container.innerHTML += `<div class="fade-in-up" style="animation-delay: ${i*0.05}s"><label class="block text-[10px] text-gray-400 uppercase font-bold mb-1 text-center">Idade ${i+1}</label><input type="number" class="form-field text-center h-10 age-input font-bold" min="0" max="99" required placeholder="00"></div>`;
        }

        document.getElementById('quote-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-submit');
            const errDiv = document.getElementById('error-message');
            const originalText = btn.innerHTML;
            errDiv.classList.add('hidden');
            
            const days = parseInt(document.getElementById('days-count').innerText);
            const ages = Array.from(document.querySelectorAll('.age-input')).map(i => i.value).filter(v => v !== "");
            
            if(!days || days <= 0 || ages.length !== STATE.paxCount) { alert('Verifique datas e idades.'); return; }

            btn.disabled = true; btn.innerHTML = `<span class="loader border-white/50 border-t-white mr-2"></span> Buscando...`;
            
            STATE.searchData = { destination: document.getElementById('destination').value, tripType: document.getElementById('trip-type').value, days, ages, origin: 'standard' };

            try {
                const res = await fetch('/.netlify/functions/coris-proxy', { method: 'POST', body: JSON.stringify(STATE.searchData) });
                const plans = await res.json();
                if(!plans || plans.length === 0 || plans.error) throw new Error(plans.error || 'Nenhum plano encontrado.');
                
                const container = document.getElementById('plans-grid'); container.innerHTML = '';
                plans.forEach(p => {
                    const finalPrice = p.originalPriceTotalBRL * 0.85;
                    container.innerHTML += `<div class="plan-card h-full p-6 group"><div><h3 class="font-bold text-xl text-gray-900">${p.nome}</h3><div class="flex gap-2 mt-2"><span class="bg-blue-50 text-blue-700 text-[10px] font-bold px-2 py-1 rounded">DMH ${p.dmh}</span><span class="bg-blue-100 text-blue-800 text-[10px] font-bold px-2 py-1 rounded">15% OFF</span></div><ul class="space-y-3 mt-6 text-sm text-gray-600"><li>✓ Desp. Médica: <strong>${p.dmh}</strong></li><li>✓ Bagagem: <strong>${p.bagagem}</strong></li><li class="text-[#2244FF] font-bold">+ 2GB Internet Grátis</li></ul></div><div class="mt-6 border-t pt-4"><p class="text-xs text-gray-400 line-through">De: R$ ${p.originalPriceTotalBRL.toFixed(2)}</p><p class="text-3xl font-bold text-[#2244FF]">R$ ${finalPrice.toFixed(2)}</p><button onclick='openModal(${JSON.stringify(p)})' class="w-full btn-primary py-3 mt-4 font-bold shadow">Comprar Agora</button></div></div>`;
                });
                document.getElementById('results').classList.remove('hidden');
                document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
            } catch(err) { console.error(err); errDiv.innerText = err.message; errDiv.classList.remove('hidden'); }
            finally { btn.disabled = false; btn.innerHTML = originalText; }
        });

        function openModal(plan) {
            STATE.selectedPlan = plan;
            const finalPrice = plan.originalPriceTotalBRL * 0.85;
            document.getElementById('summary-plan').innerText = plan.nome;
            document.getElementById('summary-price').innerText = `R$ ${finalPrice.toFixed(2)}`;
            
            const container = document.getElementById('pax-forms-container'); container.innerHTML = '';
            STATE.searchData.ages.forEach((age, i) => {
                container.innerHTML += `<div class="mt-4"><h5 class="text-xs font-bold text-gray-500 uppercase mb-2">Passageiro ${i+1} (${age} anos)</h5><div class="grid gap-3 p-4 bg-gray-50 rounded-xl border border-gray-100"><input class="form-field text-sm h-10 pax-name" placeholder="Nome Completo" required><div class="grid grid-cols-2 gap-3"><input class="form-field text-sm h-10 pax-cpf" placeholder="CPF" required><input class="form-field text-sm h-10 pax-dob" placeholder="Data Nasc" required></div></div></div>`;
            });
            document.querySelectorAll('.pax-cpf').forEach(el => IMask(el, {mask: '000.000.000-00'}));
            document.querySelectorAll('.pax-dob').forEach(el => IMask(el, {mask: '00/00/0000'}));
            
            const modal = document.getElementById('checkout-modal');
            modal.classList.remove('hidden'); void modal.offsetWidth;
            document.getElementById('modal-backdrop').classList.remove('opacity-0');
            document.getElementById('modal-panel').classList.remove('opacity-0', 'scale-95');
        }

        function closeModal() {
            document.getElementById('modal-backdrop').classList.add('opacity-0');
            document.getElementById('modal-panel').classList.add('opacity-0', 'scale-95');
            setTimeout(() => document.getElementById('checkout-modal').classList.add('hidden'), 300);
        }

        document.getElementById('payment-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-pay'); 
            const originalText = btn.innerHTML;
            if(!stripe || !card) { alert('Erro no sistema de pagamento.'); return; }
            
            btn.disabled = true; btn.innerHTML = '<span class="loader border-white/50 border-t-white"></span> Processando...';
            
            try {
                const passengers = Array.from(document.querySelectorAll('.pax-name')).map((el, i) => ({
                    nome: el.value, 
                    cpf: document.querySelectorAll('.pax-cpf')[i].value, 
                    nascimento: document.querySelectorAll('.pax-dob')[i].value,
                    sexo: 'M'
                }));

                const { paymentMethod, error } = await stripe.createPaymentMethod({ type: 'card', card: card, billing_details: { name: document.getElementById('buyer-name').value, email: document.getElementById('buyer-email').value } });
                if(error) throw new Error(error.message);

                const payload = {
                    planId: STATE.selectedPlan.id, planName: STATE.selectedPlan.nome,
                    amountBRL: parseFloat(document.getElementById('summary-price').innerText.replace('R$ ','').replace(',','.')),
                    paymentMethodId: paymentMethod.id, destination: STATE.searchData.destination, passengers: passengers,
                    dates: { departure: document.getElementById('departure-date').value.split('/').reverse().join('-'), return: document.getElementById('return-date').value.split('/').reverse().join('-') },
                    comprador: { nome: document.getElementById('buyer-name').value, email: document.getElementById('buyer-email').value, cpf: document.getElementById('buyer-cpf').value, endereco: { cep: document.getElementById('buyer-cep').value, logradouro: document.getElementById('buyer-addr').value, numero: document.getElementById('buyer-num').value } }
                };

                const res = await fetch('/.netlify/functions/process-payment', { method: 'POST', body: JSON.stringify(payload) });
                const result = await res.json();
                
                if(result.success) { alert(`SUCESSO! Voucher: ${result.voucher}`); closeModal(); document.getElementById('payment-form').reset(); card.clear(); }
                else if(result.warning) { alert(result.warning); closeModal(); }
                else throw new Error(result.error || 'Erro desconhecido.');
            } catch(err) { alert('Erro: ' + err.message); }
            finally { btn.disabled = false; btn.innerHTML = originalText; }
        });
    </script>
</body>
</html>
